{% extends 'base.html.twig' %}

{% block title %} Dashboard Inventaire {{ inventory.name|capitalize }} {% endblock %}

{% block stylesheets %}
<!-- DataTables -->
<link href="/plugins/datatables/dataTables.bootstrap4.min.css" rel="stylesheet" type="text/css" />
<link href="/plugins/datatables/buttons.bootstrap4.min.css" rel="stylesheet" type="text/css" />
<!-- Responsive datatable examples -->
<link href="/plugins/datatables/responsive.bootstrap4.min.css" rel="stylesheet" type="text/css" /> 

<link href="/plugins/timepicker/bootstrap-material-datetimepicker.css" rel="stylesheet">
<link href="/plugins/bootstrap-datepicker/css/bootstrap-datepicker.min.css" rel="stylesheet">     

<!-- Clock css -->
<link href="/plugins/daterangepicker/daterangepicker.css" rel="stylesheet" />  

<!-- Sweet Alert -->
<link href="/plugins/sweet-alert2/sweetalert2.min.css" rel="stylesheet" type="text/css">

{% endblock %}

{% block pageTitle %}
<h4 class="page-title mb-2"><i class="mdi mdi-buffer mr-2"></i>Inventaire</h4>  
{% endblock %}

{% set iconStock = true %}
{% block breadcrumb %}
    <div class="">
        <ol class="breadcrumb">
            <li class="breadcrumb-item active">Dashboard</li>
            <li class="breadcrumb-item active">Inventaire</li>
            <li class="breadcrumb-item active">{{ (inventory.name)|capitalize }}</li>
        </ol>
    </div>
{% endblock %}

{% block body %}
    
    <div class="row">
        <div class="col-lg-12 col-sm-12">
            <div class="card">
                <div class="card-body table-responsive">
                    <h5 class="header-title">Statistiques de l'inventaire de {{ inventory.name|capitalize }}</h5>
                    
                    <div class="row my-3 align-items-center">
                        <div class="col-lg-3 my-3">
                            {# <a href="{{path('lot_create', {'prod':0, 'inv':inventory.id})}}"  class="btn btn-soft-primary btn-lg rounded mr-2 mb-2 waves-effect" data-toggle="tooltip" data-placement="top" title="Ajouter un nouveau lot dans l'inventaire de {{inventory.name|capitalize}}"><i class="fa fa-plus-circle "></i></a> #}
                            {# <a href="{{path('lots_index', {'prod':0, 'inv':inventory.id})}}" class="btn btn-soft-pink  btn-lg rounded mb-2 waves-effect" data-toggle="tooltip" data-placement="top" title="Voir les Lots de l'inventaire de {{inventory.name|capitalize}}"><i class="far fa-eye"></i></a> #}
                                                            
                        </div>
                        <div class="col-lg-9">
                            <label class="">Choisir la plage de date</label>
                            <div class="input-group">  
                                <input type="text"  id="reportrange" class="form-control" value="07/10/2020">
                                <div class="input-group-append">
                                    <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                </div>
                            </div>
                        </div>
                    </div> 
                    <!-- Nav tabs -->
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-toggle="tab" href="#statisticsTab" role="tab">Statistiques de Vente</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-toggle="tab" href="#stockMovementTab" role="tab">Mouvement de Stock</a>
                        </li>                                                
                        
                    </ul>

                    <!-- Tab panes mdi mdi-dump-truck mdi mdi-truck-check -->
                    <div class="">    
                        
                        {# {% autoescape %}{{ '<span class="badge bg">on pending</span>'|raw }}{% endautoescape %} #}
                        <div class="tab-content">
                            <div class="tab-pane active p-3" id="statisticsTab" role="tabpanel">    
                                {# <button type="button" id="deliveryJournalBtn" class="btn btn-info btn-xs rounded mr-1 mb-2" data-toggle="tooltip" data-placement="top" title="Print Delivery Journal"><i class="fa fa-print"></i></button>
                                <button type="button" id="inventoryExitJournalBtn" class="btn btn-info btn-xs rounded mr-1 mb-2" data-toggle="tooltip" data-placement="top" title="Print Inventory Exit Journal"><i class="fa fa-print"></i></button>  #}
                                <table id="statistics" class="table table-striped table-fixed nowrap table-striped table-bordered" style="border-collapse: collapse; border-spacing: 0; width: 100%;">
                                    <thead>
                                        {# <tr>
                                            <th colspan="2" class="text-center font-14">Details de Produit</th>
                                            <th colspan="4" class="text-center font-14">Statistiques de vente</th>
                                        </tr> #}
                                        <tr class="text-center">
                                            <th>SKU</th>
                                            <th>Nom</th>
                                            <th>Moy Qty</th>
                                            <th>E.T</th>
                                            {# <th>Min Qty</th>
                                            <th>Max Qty</th> #}
                                            <th>Disponible</th>
                                            <th>Alertes</th>
                                            <th>Demande</th>
                                            {# <th>Actions</th> #}
                                        </tr>
                                    </thead>

                                    <tbody>
                                        {% for product in products %}                    
                                        <tr class="text-center">
                                            <td>{{ product.sku }}</td>
                                            <td><a href="#" class="editAV" data-prod="{{product.id}}" data-row={{loop.index0}} data-av=0 data-name="{{ product.name }}" data-toggle="modal" data-target=".editAV-modal-xl" data-toggle="tooltip" data-placement="top" title="Modifier la Disponibilité ?">{{ product.name }}</a></td>
                                            <td><span id="qtyAVG_{{product.id}}">0</span></td>
                                            <td><span id="ET_{{product.id}}">0</span></td>
                                            {# <td><span id="qtyMin_{{product.id}}">0</span></td>
                                            <td><span id="qtyMax_{{product.id}}">0</span></td> #}
                                            <td><span id="available_{{product.id}}">0</span></td>
                                            
                                            <td>
                                                {# <div class="checkbox checkbox-primary">
                                                    <input id="checkbox{{commercialSheet.id}}" type="checkbox" name="delivered" value="{{commercialSheet.id}}">
                                                    <label for="checkbox{{commercialSheet.id}}"></label>
                                                </div> dripicons-warning #}
                                                
                                                {# {% set ss = productStats[product.id][0]["ET"] * inventory.const %}
                                                {% set pc = ss + productStats[product.id][0]["qtyAVG"] * inventory.approvDelay %}
                                                {% if available[product.id].available <= pc %} #}
                                                <a href="" class="mr-2 d-none" id="alertRefuel_{{product.id}}" data-toggle="tooltip" data-placement="top" title="Alerte Réapprovisionnement">
                                                    <i class="fas fa-exclamation-triangle text-warning"></i>
                                                </a>
                                                <span class="bg bg-soft-success d-none" id="noAlertRefuel_{{product.id}}"></span>
                                                {# {% endif %} #}
                                                {# {% set lotPeremp = [] %}
                                                {% for lot in product.lots %}
                                                    {% if lot.alert == false and lot.quantity > 0 and lot.inventory == inventory %}
                                                        {% set lotPeremp = lotPeremp|merge([lot]) %}
                                                    
                                                    {% endif %} 
                                                {% endfor %}
                                                {% if lotPeremp|length > 0 %}
                                                <a href="" class="" data-toggle="modal" data-target=".bd-example-modal-xl_{{product.id}}" data-toggle="tooltip" data-placement="top" title="Alerte Lots Expirés"><i class="fas fa-exclamation-triangle text-danger "></i></a>
                                                <!-- Custom Modal -->
                                                
                                                <div class="modal fade bd-example-modal-xl_{{product.id}}" tabindex="-1" role="dialog" aria-labelledby="myExtraLargeModalLabel" aria-hidden="true">
                                                    <div class="modal-dialog modal-xl">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title mt-0" id="myModalLabel">Expiration Alert</h5>
                                                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                                            </div>
                                                            <div class="modal-body">
                                                                <table id="datatable2" class="table nowrap table-striped table-bordered" style="border-collapse: collapse; border-spacing: 0; width: 100%;">
                                                                    <thead>
                                                                        <tr class="text-center">
                                                                            <th>N° Lot</th>
                                                                            <th>DLC</th>
                                                                            <th>À Supprimer</th>
                                                                        </tr>
                                                                    </thead>

                                                                    <tbody>
                                                                        
                                                                        {% for lot_ in lotPeremp %}
                                                                        <tr class="text-center">
                                                                            <td>{{ lot_.number }}</td>
                                                                            <td>{{ lot_.dlc|date('d-m-Y') }}</td>
                                                                            <td style="width:5px">
                                                                                <div class="checkbox checkbox-primary">
                                                                                    <input id="lot{{lot_.id}}" type="checkbox" name="lotToRemove" value="{{lot_.id}}">
                                                                                    <label for="lot{{lot_.id}}"></label>
                                                                                </div>
                                                                            </td>
                                                                        </tr>
                                                                        {% endfor %}
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-soft-warning waves-effect" data-dismiss="modal">Fermer</button>
                                                                <button type="button" id="saveBtn" data-toggle="tooltip" data-placement="top" title="Supprimer les lots sélectionnés" data-action="place" data-target="{{'1'}}" class="btn btn-soft-danger btn-lg">
                                                                    <span class="spinner-border spinner-border-sm mr-1 d-none" role="status" aria-hidden="true"></span>
                                                                    Supprimer
                                                                </button>
                                                                
                                                            </div>
                                                        </div><!-- /.modal-content -->
                                                    </div><!-- /.modal-dialog -->
                                                </div>
                                                {% endif %} #}
                                            </td>
                                            <td><span id="demand_{{product.id}}"></span></td>
                                            {# <td>
                                                <!-- {{ productStats[product.id][0]["qtyAVG"] * inventory.orderingFreq }} <a href="#custom-modal{{'0'}}" class="btn btn-primary btn-xs rounded waves-effect" data-animation="corner" data-plugin="custommodal" data-overlayColor="#38414a" data-toggle="tooltip" data-placement="top" title="Add New Lot"><i class="fa fa-plus-circle"></i></a> -->
                                                <a href="{{path('lot_create', {'prod':product.id, 'inv':inventory.id})}}"  class="btn btn-soft-info btn-xs rounded waves-effect" data-toggle="tooltip" data-placement="top" title="Ajouter un nouveau lot pour le produit {{product.name}}"><i class="fa fa-plus-circle"></i></a>
                                                <a href="{{path('lots_index', {'prod':product.id, 'inv':inventory.id})}}" class="btn btn-soft-purple btn-xs rounded waves-effect" data-toggle="tooltip" data-placement="top" title="Voir les Lots du produit {{product.name}}"><i class="far fa-eye"></i></a>
                                                <!-- <a href="#custom-modal{{'1'}}" class="btn btn-danger btn-xs rounded waves-effect" data-animation="corner" data-plugin="custommodal" data-overlayColor="#38414a" data-toggle="tooltip" data-plas"top" title="Remove Lot"><i class="fas fa-trash"></i></a> -->
                                            </td>  #}
                                            
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>       

                                <div class="modal fade editAV-modal-xl" id="editAV-modal-xl" tabindex="-1" role="dialog" aria-labelledby="myExtraLargeModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-xl">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title mt-0" id="myModalLabel">Modification de la disponibilité en Stock</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="form-group">
                                                    <div class="input-group">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text">SKU</span>
                                                        </div>
                                                        <input type="text" id="sku" class="form-control" disabled value="A1001"></input>
                                                    </div>                                                    
                                                </div>
                                                <div class="form-group">
                                                    <div class="input-group">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text">Nom</span>
                                                        </div>
                                                        <input type="text" id="productName" class="form-control" disabled value="Ma première purée de carottes"></input>
                                                    </div>                                                    
                                                </div>
                                                <div class="form-group">
                                                    {# <label>Left Addons With Textarea</label> #}
                                                    <div class="input-group">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text">Disponibilité</span>
                                                        </div>
                                                        <input type="number" id="available" min="0" class="form-control" value="0"></input>
                                                    </div>                                                    
                                                </div>
                                                <input type="hidden" id="tableRow">
                                                <input type="hidden" id="prod">
                                            </div>
                                            <div class="modal-footer">
                                                {# <button type="button" class="btn btn-soft-warning waves-effect" data-dismiss="modal">Fermer</button> #}
                                                <button type="button" id="saveAVBtn" data-toggle="tooltip" data-placement="top" title="Sauvegarder les Modifications" class="btn btn-soft-primary btn-lg">
                                                    <span class="spinner-border spinner-border-sm mr-1 d-none" role="status" aria-hidden="true"></span>
                                                    Sauvegarder
                                                </button>
                                                
                                            </div>
                                        </div><!-- /.modal-content -->
                                    </div><!-- /.modal-dialog -->
                                </div> 

                            </div>

                            <div class="tab-pane p-3" id="stockMovementTab" role="tabpanel">
                                {# <div class="form-group my-2">
                                    <h6 class=" input-title mt-lg-3">Specify the Date Range</h6>
                                    <div class="row">
                                        <div class="input-daterange input-group col-6" id="date-range">
                                            <input type="text" class="form-control" name="start" placeholder="Start Date (dd/mm/yyyy)" />
                                            <input type="text" class="form-control" name="end" placeholder="End Date (dd/mm/yyyy)" />
                                            <span class="input-group-append">
                                                <button type="button" id="reloadBtn" class="btn btn-soft-primary"><i class="fas fa-sync"></i> </button>
                                            </span>
                                        </div>
                                    </div>
                                </div> #}
                                <div class="table-responsive">
                                    <table id="datatable-buttons" class="table table-striped table-fixed nowrap" style="border-collapse: collapse; border-spacing: 0; width: 100%;">
                                        <thead>
                                            <tr class="text-center">
                                                {# <th style="width:0.5em"></th> #}
                                                <th>Date</th>
                                                <th>SKU</th>
                                                <th>Nom</th>
                                                {# <th>N° Lot</th>
                                                <th>DLC</th> #}
                                                <th>Type</th>
                                                <th>Qté</th>
                                            </tr>
                                        </thead>

                                        <tbody>
                                            {# {% for i in range(1,4) %}
                                            <tr class="text-center align-items-center">
                                                <td></td> 
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td class="align-items-center">
                                                    
                                                    
                                                </td>
                                                <td></td>
                                                
                                            </tr>
                                            {% endfor %} #}
                                        </tbody>
                                    </table>
                                </div>
                            </div>  

                        </div>

                    </div> <!--end div-->
                    
                </div>
            </div>
        </div>
    </div><!--end row-->
{% endblock %}

{% block javascripts %}
<!-- Required datatable js -->
<script src="/plugins/datatables/jquery.dataTables.min.js"></script>
<script src="/plugins/datatables/dataTables.bootstrap4.min.js"></script>
<!-- Buttons examples -->
{# <!-- 

https://code.jquery.com/jquery-3.5.1.js
https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js
https://cdn.datatables.net/fixedheader/3.1.7/js/dataTables.fixedHeader.min.js
https://cdn.datatables.net/buttons/1.6.4/js/dataTables.buttons.min.js
https://cdn.datatables.net/buttons/1.6.4/js/buttons.colVis.min.js

--> #}

{% block jquerySrc %}<script src="https://code.jquery.com/jquery-3.5.1.js"></script>{% endblock %}
<script src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
{# <script src="/plugins/datatables/dataTables.buttons.min.js"></script> #}
<script src="https://cdn.datatables.net/buttons/1.6.4/js/dataTables.buttons.min.js"></script>
<script src="/plugins/datatables/buttons.bootstrap4.min.js"></script>
{# <script src="/plugins/datatables/jszip.min.js"></script> #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
{# <script src="/plugins/datatables/pdfmake.min.js"></script> #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
{# <script src="/plugins/datatables/vfs_fonts.js"></script> #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
{# <script src="/plugins/datatables/buttons.html5.min.js"></script> #}
<script src="https://cdn.datatables.net/buttons/1.6.4/js/buttons.html5.min.js"></script>
{# <script src="/plugins/datatables/buttons.print.min.js"></script> #}
<script src="https://cdn.datatables.net/buttons/1.6.4/js/buttons.print.min.js"></script>
{# <script src="/plugins/datatables/buttons.colVis.min.js"></script> #}
<script src="https://cdn.datatables.net/buttons/1.6.4/js/buttons.colVis.min.js"></script>
<!-- Responsive examples -->
{# <script src="/plugins/datatables/dataTables.responsive.min.js"></script> #}
{# <script src="/plugins/datatables/responsive.bootstrap4.min.js"></script> #}
<script src="https://cdn.datatables.net/1.10.22/js/dataTables.bootstrap4.min.js"></script>
<script src="/pages/jquery.datatable.init.js"></script>    

<script src="/plugins/custombox/custombox.min.js"></script>
<script src="/plugins/custombox/custombox.legacy.min.js"></script>

<script src="/pages/jquery.modal-animation.js"></script>
<script src="/js/jquery.redirect.js"></script>  

<!-- Plugins js -->
<script src="/plugins/moment/moment.js"></script>
<script src="/plugins/daterangepicker/daterangepicker.js"></script>
<script src="/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js"></script>
<script src="/pages/jquery.forms-advanced1.js"></script>

<!-- Sweet-Alert  -->
<script src="/plugins/sweet-alert2/sweetalert2.min.js"></script>


<script>
    var alertRefuel = '<a href="" class="mr-2 d-none" data-toggle="tooltip" data-placement="top" title="Alerte Réapprovisionnement"><i class="fas fa-exclamation-triangle text-warning"></i></a>';
    
    /*var rowHtml = $("#newRow").find("tr")[0].outerHTML
    console.log(rowHtml);
    t.row.add($(rowHtml)).draw();*/

    var inv = {{ inventory.id }};
    var now = new Date();
    var jsDate = now.getDate()+'-'+(now.getMonth()+1)+'-'+now.getFullYear();
    var availableFileName = 'Etat | Stock de {{ (inventory.name)|capitalize }} | Date : ' + jsDate.toString();
    var demandFileName = 'Demande Réapprivisionnement | Stock de {{ (inventory.name)|capitalize }} | Date ' + jsDate.toString();
    console.log(availableFileName);
    {# // Function to convert an img URL to data URL
	function getBase64FromImageUrl(url) {
        var img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = function () {
            var canvas = document.createElement("canvas");
            canvas.width =this.width;
            canvas.height =this.height;
            var ctx = canvas.getContext("2d");
            ctx.drawImage(this, 0, 0);
            var dataURL = canvas.toDataURL("image/png");
            return dataURL.replace(/^data:image\/(png|jpg);base64,/, "");
        };
        img.src = url;
    } #}
    var statsTable = $('#statistics').DataTable({
        //dom: 'Bfrtip',
        lengthChange: true,
        lengthMenu: [ 10, 25, 50, 100, 200 ],
        pageLength: 200,
        buttons: [
            {
                text: 'Exporter Disponibilité',
                extend: 'pdfHtml5',
                filename: availableFileName,
                exportOptions: {
                    columns: [ 0, 1, 4 ],
                    //columns: ':visible'
                    search: 'applied',
                    order: 'applied'
                },
                title: function( thead, data, start, end, display ) {
                    return "{{app.user.enterprise.socialReason}}\r\n" + availableFileName;
                },
                customize: function (doc) {
                    //Remove the title created by datatTables
                    {# {% if app.user.enterprise.logo != null %}
                    var logo = getBase64FromImageUrl("{{ '/images/uploads/logo/' ~ app.user.enterprise.logo }}");
                    {% endif %}
                    //doc.content.splice(0,1);
                    doc.content.splice( 1, 0, {
                        margin: [ 0, 0, 0, 12 ],
                        alignment: 'center',
                        {% if app.user.enterprise.logo != null %}image: logo{% endif %}
                    } ); #}
                    //Create a date string that we use in the footer. Format is dd-mm-yyyy
                    var now = new Date();
                    var jsDate = now.getDate()+'-'+(now.getMonth()+1)+'-'+now.getFullYear();
                    // Logo converted to base64
                    // var logo = getBase64FromImageUrl('https://datatables.net/media/images/logo.png');
                    // The above call should work, but not when called from codepen.io
                    // So we use a online converter and paste the string in.
                    // Done on http://codebeautify.org/image-to-base64-converter
                    // It's a LONG string scroll down to see the rest of the code !!!
                    //var logo = 'data:image/jpeg;base64,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ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA=';
                    // A documentation reference can be found at
                    // https://github.com/bpampuch/pdfmake#getting-started
                    // Set page margins [left,top,right,bottom] or [horizontal,vertical]
                    // or one number for equal spread
                    // It's important to create enough space at the top for a header !!!
                    doc.pageMargins = [60,60,60,30];
                    // Set the font size fot the entire document
                    doc.defaultStyle.fontSize = 12;
                    // Set the fontsize for the table header
                    doc.styles.tableHeader.fontSize = 13;
                    //doc.styles.tableBodyOdd.fillColor = "yellow";
                    doc.styles.tableBodyOdd.alignment = function (rowIndex, node, columnIndex) {
                                                    return (rowIndex >= 0) ? 'center' : null;
                                                };
                    doc.styles.tableHeader.fillColor = "#6c757d";
                    console.log(doc);
                    var objTable = {};
                    //objTable['heights'] = (function(i) { return 100; });
                    //objTable['widths'] = ['*', 'auto', '*', 'auto', 'auto', 'auto'];
                    //objTable['widths']   = (function(i) { return ['*', 'auto', '*', 'auto', 'auto', 'auto']; });
                    //doc.content[1].table = objTable; 
                    doc.content[1].table.widths = ['auto', '*', 'auto']; 
                    //doc.content[1].table.heights = (function(i) { return 100; }); 
                    doc.content[1].layout = {
                                                fillColor: function (rowIndex, node, columnIndex) {
                                                    return (rowIndex % 2 === 0) ? '#CCCCCC' : null;
                                                }
                                            }; 
                        
                    // Create a header object with 3 columns
                    // Left side: Logo
                    // Middle: brandname
                    // Right side: A document title
                    /*doc['header']=(function() {
                        return {
                            columns: [
                                {
                                    //image: logo,
                                    "width": 24
                                },
                                {
                                    alignment: 'left',
                                    italics: true,
                                    text: 'dataTables',
                                    fontSize: 18,
                                    margin: [10,0]
                                },
                                {
                                    alignment: 'right',
                                    fontSize: 14,
                                    text: 'Custom PDF export with dataTables'
                                }
                            ],
                            margin: 20
                        }
                    });*/
                    // Create a footer object with 2 columns
                    // Left side: report creation date
                    // Right side: current page and total pages
                    doc['footer']=(function(page, pages) {
                        return {
                            columns: [
                                {
                                    alignment: 'left',
                                    text: ['Crée le : ', { text: jsDate.toString() }]
                                },
                                {
                                    alignment: 'center',
                                    text: ['{{app.user.enterprise.socialReason}} {% if app.user.enterprise.niu is not empty %}- NIU : {{app.user.enterprise.niu}} {% endif %} {% if app.user.enterprise.rccm is not empty %}- RCCM : {{app.user.enterprise.rccm}}{% endif %}']
                                },
                                {
                                    alignment: 'right',
                                    text: ['page ', { text: page.toString() },	' de ',	{ text: pages.toString() }]
                                }
                            ],
                            margin: 20
                        }
                    });
                    // Change dataTable layout (Table styling)
                    // To use predefined layouts uncomment the line below and comment the custom lines below
                    // doc.content[0].layout = 'lightHorizontalLines'; // noBorders , headerLineOnly
                    var objLayout = {};
                    objLayout['hLineWidth']   = (function(i) { return .5; });
                    objLayout['vLineWidth']   = (function(i) { return .5; });
                    objLayout['hLineColor']   = (function(i) { return '#ccc'; });
                    objLayout['vLineColor']   = (function(i) { return '#ccc'; });
                    objLayout['paddingLeft']  = (function(i) { return 4; });
                    objLayout['paddingRight'] = (function(i) { return 4; });
                    doc.content[0].layout = objLayout;
                } 
            },
            {
                text: 'Exporter Demande',
                extend: 'pdfHtml5',
                filename: demandFileName,
                exportOptions: {
                    columns: [ 0, 1, 6 ],
                    search: 'applied',
                    order: 'applied'
                },
                title: function( thead, data, start, end, display ) {
                    return "{{app.user.enterprise.socialReason}}\r\n" + demandFileName;
                },
                customize: function (doc) {
                    //Remove the title created by datatTables
                    //doc.content.splice(0,1);
                    //Create a date string that we use in the footer. Format is dd-mm-yyyy
                    var now = new Date();
                    var jsDate = now.getDate()+'-'+(now.getMonth()+1)+'-'+now.getFullYear();
                    // Logo converted to base64
                    // var logo = getBase64FromImageUrl('https://datatables.net/media/images/logo.png');
                    // The above call should work, but not when called from codepen.io
                    // So we use a online converter and paste the string in.
                    // Done on http://codebeautify.org/image-to-base64-converter
                    // It's a LONG string scroll down to see the rest of the code !!!
                    //var logo = 'data:image/jpeg;base64,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ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA=';
                    // A documentation reference can be found at
                    // https://github.com/bpampuch/pdfmake#getting-started
                    // Set page margins [left,top,right,bottom] or [horizontal,vertical]
                    // or one number for equal spread
                    // It's important to create enough space at the top for a header !!!
                    doc.pageMargins = [60,60,60,30];
                    // Set the font size fot the entire document
                    doc.defaultStyle.fontSize = 12;
                    // Set the fontsize for the table header
                    doc.styles.tableHeader.fontSize = 13;
                    //doc.styles.tableBodyOdd.fillColor = "yellow";
                    doc.styles.tableBodyOdd.alignment = function (rowIndex, node, columnIndex) {
                                                    return (rowIndex >= 0) ? 'center' : null;
                                                };
                    doc.styles.tableHeader.fillColor = "#6c757d";
                    //console.log(doc);
                    var objTable = {};
                    //objTable['heights'] = (function(i) { return 100; });
                    //objTable['widths'] = ['*', 'auto', '*', 'auto', 'auto', 'auto'];
                    //objTable['widths']   = (function(i) { return ['*', 'auto', '*', 'auto', 'auto', 'auto']; });
                    //doc.content[1].table = objTable; 
                    doc.content[1].table.widths = ['auto', '*', 'auto']; 
                    //doc.content[1].table.heights = (function(i) { return 100; }); 
                    doc.content[1].layout = {
                                                fillColor: function (rowIndex, node, columnIndex) {
                                                    return (rowIndex % 2 === 0) ? '#CCCCCC' : null;
                                                }
                                            }; 
                        
                    // Create a header object with 3 columns
                    // Left side: Logo
                    // Middle: brandname
                    // Right side: A document title
                    /*doc['header']=(function() {
                        return {
                            columns: [
                                {
                                    //image: logo,
                                    "width": 24
                                },
                                {
                                    alignment: 'left',
                                    italics: true,
                                    text: 'dataTables',
                                    fontSize: 18,
                                    margin: [10,0]
                                },
                                {
                                    alignment: 'right',
                                    fontSize: 14,
                                    text: 'Custom PDF export with dataTables'
                                }
                            ],
                            margin: 20
                        }
                    });*/
                    // Create a footer object with 2 columns
                    // Left side: report creation date
                    // Right side: current page and total pages
                    doc['footer']=(function(page, pages) {
                        return {
                            columns: [
                                {
                                    alignment: 'left',
                                    text: ['Crée le : ', { text: jsDate.toString() }]
                                },
                                {
                                    alignment: 'center',
                                    text: ['{{app.user.enterprise.socialReason}} {% if app.user.enterprise.niu is not empty %}- NIU : {{app.user.enterprise.niu}} {% endif %} {% if app.user.enterprise.rccm is not empty %}- RCCM : {{app.user.enterprise.rccm}}{% endif %}']
                                },
                                {
                                    alignment: 'right',
                                    text: ['page ', { text: page.toString() },	' de ',	{ text: pages.toString() }]
                                }
                            ],
                            margin: 20
                        }
                    });
                    // Change dataTable layout (Table styling)
                    // To use predefined layouts uncomment the line below and comment the custom lines below
                    // doc.content[0].layout = 'lightHorizontalLines'; // noBorders , headerLineOnly
                    var objLayout = {};
                    objLayout['hLineWidth']   = (function(i) { return .5; });
                    objLayout['vLineWidth']   = (function(i) { return .5; });
                    objLayout['hLineColor']   = (function(i) { return '#ccc'; });
                    objLayout['vLineColor']   = (function(i) { return '#ccc'; });
                    objLayout['paddingLeft']  = (function(i) { return 4; });
                    objLayout['paddingRight'] = (function(i) { return 4; });
                    doc.content[0].layout = objLayout;
                } 
            }, 
            //'colvis'
            ],
    });
    
    statsTable.buttons().container()
        .appendTo('#statistics_wrapper .col-md-6:eq(0)');

    //Buttons examples
    var table = $('#datatable-buttons').DataTable({
        //dom: 'Bfrtip',
        //lengthChange: true,
        //lengthMenu: [ [10, 25, 50, -1], [10, 25, 50, 100, "All"] ],
        pageLength: 100,
        buttons: ['pdf'],//'copy', 'excel', , 'colvis'
        //ajax: "data.json"
    });

    table.buttons().container()
        .appendTo('#datatable-buttons_wrapper .col-md-6:eq(0)');

    
    $(document).ready(function(){
        $('.buttons-pdf').children('span').prepend('<i class="mdi mdi-download mr-2"></i>');

        $('.editAV').click(function(){
            {# console.log('row = ' + $(this).data('row'));
            var av = statsTable.cell($(this).data('row'),4).data();
            $(this).data('av', av);
            console.log('av = ' + $(this).data('av')); 
            //statsTable.cell($(this).data('row'),4).data(0); 
            #}

            $('#sku').val(statsTable.cell($(this).data('row'),0).data());
            $('#productName').val($(this).data('name'));
            $('#available').val(statsTable.cell($(this).data('row'),4).data());
            $('#tableRow').val($(this).data('row'));
            $('#prod').val($(this).data('prod'));
            //console.log('tableRow = ' + $('#tableRow').val());
        });

        $('#saveAVBtn').click(function(){
            var $data = JSON.stringify({
                {# "SKU": $('#sku').val(),
                "Name": $('#productName').val(), #}
                "prod": $('#prod').val(),
                "available": $('#available').val(),
                "inv": inv
            });   

            swal.queue([{
                title: 'Modification de la disponibilité du produit ' + $('#productName').val() + " dans l'inventaire " + "{{ inventory.name|capitalize }}",
                confirmButtonText: 'Confirmez',
                text: 'Disponibilité = ' + $('#available').val(),
                showCancelButton: true,
                showLoaderOnConfirm: true,
                confirmButtonClass: 'btn btn-primary',
                cancelButtonClass: 'btn btn-info ml-2',
                preConfirm: function () {
                    return new Promise(function (resolve) {
                        
                        $.ajax({
                            type: "POST",//method type
                            contentType: "application/json; charset=utf-8",
                            url: "{{ path('update_product_availability') }}",///Target function that will be return result
                            data: $data,//parameter pass data is parameter name param is value 
                            dataType: "json",
                            timeout: 120000,//64241
                            success: function (data) {
                                {# console.log(data)   ; #}

                                statsTable.cell($('#tableRow').val(),4).data($('#available').val());

                                swal({
                                    type: 'success',
                                    title: 'La disponibilité a été mis à jour avec succès !',
                                    //html: 'Submitted email: ' + email
                                });

                                setTimeout(function () {
                                    resolve();
                                    //Fermer le modal d'édition
                                    //$('#editAV-modal-xl').modal('toggle');   

                                }, 2000);
                            },
                            error: function (result) {
                                //console.log("Error");
                                //console.log(result);
                                swal(
                                    'Oops...',
                                    "Une erreur s'est produite !",
                                    'error'
                                    //footer: '<a href>Why do I have this issue?</a>'
                                );

                                setTimeout(function () {
                                    resolve()
                                }, 5000);
                            }
                        });
                    })
                },
                allowOutsideClick: false
            }]);

        });
    });

    var const_ = {{ inventory.const }};
    var approvDelay = {{ inventory.approvDelay }};
    var freqReapp = {{ inventory.orderingFreq }};

    var _url = "{{path('stock_movement_update')}}";
        
    $('#reportrange').on('apply.daterangepicker', function(ev, picker) {
        //console.log(picker.startDate.format('YYYY-MM-DD'));
        //console.log(picker.endDate.format('YYYY-MM-DD'));
        //$('.fa-sync').addClass('fa-spin');
        var startDate = picker.startDate.format('YYYY-MM-DD');
        var endDate = picker.endDate.format('YYYY-MM-DD');
        
        //console.log('startDate = ' + startDate);
        //console.log('endDate = ' + endDate);
        //block of code that runs when the click event triggers
        
        var $data = JSON.stringify({
            "startDate": startDate,//tabGridId,
            "endDate": endDate,//tabFuelId,
            "inv": inv
        });   

        //Danger
        
        swal.queue([{
            title: 'Les données des tableaux seront mise à jour pour la plage de date suivante : ',
            confirmButtonText: 'Confirmez',
            text: 'Du ' + startDate + ' Au ' + endDate,
            showCancelButton: true,
            showLoaderOnConfirm: true,
            confirmButtonClass: 'btn btn-primary',
            cancelButtonClass: 'btn btn-info ml-2',
            preConfirm: function () {
                return new Promise(function (resolve) {
                    /*$.get('https://api.ipify.org?format=json')
                        .done(function (data) {
                            swal.insertQueueStep(data.ip)
                            resolve()
                        })*/
                    $.ajax({
                        type: "POST",//method type
                        contentType: "application/json; charset=utf-8",
                        url: "{{path('stock_movement_update')}}",///Target function that will be return result
                        data: $data,//parameter pass data is parameter name param is value 
                        dataType: "json",
                        timeout: 120000,//64241
                        success: function (data) {
                            //$('.fa-sync').removeClass('fa-spin');                                  
                            //console.log(data);
                            
                            //console.log(data['productStats']);

                             //statsTable.clear().draw(); 
                            table.clear().draw();
                            var ss = 0, pc = 0.0; 
                            
                            data['productStats'].forEach(function (value, index) {
                                console.log('value = ' + value);
                                {# $('#qtyAVG_' + value['id']).text(value['AVG']);
                                $('#ET_' + value['id']).text(value['ET']);
                                $('#qtyMin_' + value['id']).text(value['MIN']);
                                $('#qtyMax_' + value['id']).text(value['MAX']); 
                                $('#available_' + value['id']).text(data['available'][index]['av']); #}

                                statsTable.cell(index,2).data(value['AVG']).draw();
                                statsTable.cell(index,3).data(value['ET']).draw();
                                statsTable.cell(index,4).data(data['available'][index]['av']).draw();
                                
                                /*statsTable
                                    .row.add( [ value['Sku'], String(value['Name']), 
                                    String(value['AVG']), String(value['ET']),value['MIN'],
                                    String(value['MAX']), String(data['available'][index]['av'])] )
                                    .draw();*/

                                ss = parseFloat(value['ET']) * const_;
                                pc = ss + parseFloat(value['AVG']) * approvDelay;

                                if(parseInt(data['available'][index]['av']) <= pc){
                                    $('#alertRefuel_' + value['id']).removeClass('d-none');
                                    $('#noAlertRefuel_' + value['id']).addClass('d-none');
                                    var tmp = parseFloat(value['AVG']) * freqReapp;
                                    {# $('#demand_' + value['id']).text(Math.ceil(tmp)); #}
                                    statsTable.cell(index,6).data(Math.ceil(tmp)).draw();
                                    //console.log('alert');
                                }
                                else {
                                    $('#alertRefuel_' + value['id']).addClass('d-none');
                                    $('#noAlertRefuel_' + value['id']).removeClass('d-none');
                                    {# $('#demand_' + value['id']).text(0); #}
                                    statsTable.cell(index,6).data("0").draw();
                                    //console.log('no alert');
                                }
                            });

                            var stockMovementTab = data['stockMovements'];
                            if(stockMovementTab){
                                //console.log('Type = ' + typeof stockMovementTab.length);  
                                //console.log(stockMovementTab);  
                                stockMovementTab.forEach(function (item, index) {
                                    {# var $dat = new moment(String(item['dat']));
                                    var date = $dat.format("DD MMM YYYY hh:mm:ss").toString();
                                    
                                    $dat = new moment(String(item['dlc']));
                                    var dlc = $dat.format("DD MMM YYYY").toString(); #}
                        
                                    {# table
                                    .row.add( [ item['dat'], String(item['sku']), 
                                    String(item['nam']), String(item['numLot']),item['dlc'],
                                    String(item['typ']), String(item['qty'])] )
                                    .draw(); #}

                                    table
                                    .row.add( [ item['dat'], String(item['sku']), 
                                    String(item['nam']),String(item['typ']), String(item['qty'])] )
                                    .draw();
                                    });

                            } 
                            swal({
                                type: 'success',
                                title: 'Les Données de la page ont été Mis à Jour avec succès !',
                                //html: 'Submitted email: ' + email
                            });

                            setTimeout(function () {
                                resolve()
                            }, 2000);
                        },
                        error: function (result) {
                            //console.log("Error");
                            //console.log(result);
                            swal(
                                'Oops...',
                                'Something went wrong!',
                                'error'
                                //footer: '<a href>Why do I have this issue?</a>'
                            );

                            setTimeout(function () {
                                resolve()
                            }, 5000);
                        }
                    });
                })
            },
            allowOutsideClick: false
        }]);
        

    });


    var drp = $('#reportrange').data('daterangepicker');
    //console.log('drp = ' + drp.startDate.format('YYYY-MM-DD'));
    var startDate = drp.startDate.format('YYYY-MM-DD');
    var endDate = drp.endDate.format('YYYY-MM-DD');
    
    // console.log('startDate = ' + startDate);
    //console.log('endDate = ' + endDate); 
    //block of code that runs when the click event triggers
    
    var $data = JSON.stringify({
        "startDate": startDate,//tabGridId,
        "endDate": endDate,//tabFuelId,
        "inv": inv
    });   

    //Danger
    
    swal.queue([{
        title: 'Les données des tableaux seront mise à jour pour la plage de date suivante : ',
        confirmButtonText: 'Confirmez',
        text: 'Du ' + startDate + ' Au ' + endDate,
        //showCancelButton: true,
        showLoaderOnConfirm: true,
        confirmButtonClass: 'btn btn-primary',
        //cancelButtonClass: 'btn btn-info ml-2',
        preConfirm: function () {
            return new Promise(function (resolve) {
                /*$.get('https://api.ipify.org?format=json')
                    .done(function (data) {
                        swal.insertQueueStep(data.ip)
                        resolve()
                    })*/
                $.ajax({
                    type: "POST",//method type
                    contentType: "application/json; charset=utf-8",
                    url: _url,///Target function that will be return result
                    data: $data,//parameter pass data is parameter name param is value 
                    dataType: "json",
                    timeout: 120000,//64241
                    success: function (data) {
                        //$('.fa-sync').removeClass('fa-spin');                                  
                        console.log(data);
                        
                        //console.log(data['productStats']);

                        // statsTable.clear().draw(); 
                        table.clear().draw();
                        var ss = 0, pc = 0.0; 
                        
                        data['productStats'].forEach(function (value, index) {
                            //console.log('value = ' + value);
                            {# $('#qtyAVG_' + value['id']).text(value['AVG']);
                            $('#ET_' + value['id']).text(value['ET']);
                            $('#qtyMin_' + value['id']).text(value['MIN']);
                            $('#qtyMax_' + value['id']).text(value['MAX']); 
                            $('#available_' + value['id']).text(data['available'][index]['av']); #}
                            
                            statsTable.cell(index,2).data(value['AVG']).draw();
                            statsTable.cell(index,3).data(value['ET']).draw();
                            statsTable.cell(index,4).data(data['available'][index]['av']).draw();

                            {# statsTable
                                .rows({ selected: true })
                                .every(function (rowIdx, tableLoop, rowLoop) {
                                    statsTable.cell(rowIdx,2).data(value['AVG']);
                                    statsTable.cell(rowIdx,3).data(value['ET']);
                                    statsTable.cell(rowIdx,4).data(data['available'][index]['av']);
                                    
                                })
                                .draw(); #}
                            ss = parseFloat(value['ET']) * const_;
                            pc = ss + parseFloat(value['AVG']) * approvDelay;

                            if(parseInt(data['available'][index]['av']) <= pc){
                                $('#alertRefuel_' + value['id']).removeClass('d-none');
                                $('#noAlertRefuel_' + value['id']).addClass('d-none');
                                var tmp = parseFloat(value['AVG']) * freqReapp;
                                $('#demand_' + value['id']).text(Math.ceil(tmp));
                                statsTable.cell(index,6).data(String(Math.ceil(tmp))).draw();
                                // console.log('alert'); 
                            }
                            else {
                                $('#alertRefuel_' + value['id']).addClass('d-none');
                                $('#noAlertRefuel_' + value['id']).removeClass('d-none');
                                {# $('#demand_' + value['id']).text(0); #}
                                statsTable.cell(index,6).data("0").draw();
                                // console.log('no alert'); 
                            }
                        });

                        var stockMovementTab = data['stockMovements'];
                        if(stockMovementTab){
                            //console.log('Type = ' + typeof stockMovementTab.length);  
                            console.log(stockMovementTab);  
                            stockMovementTab.forEach(function (item, index) {
                                {# var $dat = new moment(String(item['dat']));
                                var date = $dat.format("DD MMM YYYY hh:mm:ss").toString();
                                
                                $dat = new moment(String(item['dlc']));
                                var dlc = $dat.format("DD MMM YYYY").toString(); #}
                    
                                {# table
                                .row.add( [ item['dat'], String(item['sku']), 
                                String(item['nam']), String(item['numLot']),item['dlc'],
                                String(item['typ']), String(item['qty'])] )
                                .draw(); #}

                                table
                                .row.add( [ item['dat'], String(item['sku']), 
                                String(item['nam']),String(item['typ']), String(item['qty'])] )
                                .draw();

                            });

                        } 
                        swal({
                            type: 'success',
                            title: 'Les Données de la page ont été Mis à Jour avec succès !',
                            //html: 'Submitted email: ' + email
                        });

                        setTimeout(function () {
                            resolve()
                        }, 2000);
                    },
                    error: function (result) {
                        //console.log("Error");
                        //console.log(result);
                        swal(
                            'Oops...',
                            'Something went wrong!',
                            'error'
                            //footer: '<a href>Why do I have this issue?</a>'
                        );

                        setTimeout(function () {
                            resolve()
                        }, 5000);
                    }
                });
            })
        },
        allowOutsideClick: false
    }]);
       
    {# $('#saveBtn').click(function(){
        //console.log('Lot To Remove Btn clicked');
        var tabLotToRemove = [];
        $("input:checkbox[name=lotToRemove]:checked").each(function(){
            tabLotToRemove.push($(this).val());
        });
        //console.log('Tab Lot To Remove : ' + tabLotToRemove);
        if (tabLotToRemove.length > 0){

            var _url = "{{ path('lot_expired') }}";

            var $data = JSON.stringify({
                "lotIds": tabLotToRemove
            });

            $.ajax({
                type: "POST",//method type
                contentType: "application/json; charset=utf-8",
                url: _url,///Target function that will be return result
                data: $data,//parameter pass data is parameter name param is value 
                dataType: "json",
                timeout: 120000,//64241
                success: function (data) {
                    //console.log(data);
                    location.reload(true);
                },
                error: function (result) {
                    //console.log("Error");
                    //console.log(result);
                    alert('Erreur !!!');
                    //$('#modal').modal('toggle');
                }
            });

        }
        else{
            $('.modal-body').
            prepend('<div class="alert icon-custom-alert alert-outline-danger alert-danger-shadow alert-dismissible fade show" role="alert"><div class="alert-text"><strong>Aucun Lot n\'est sélectionné pour la suppression !</strong></div><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true"><i class="mdi mdi-close"></i></span></button></div>');
            
        }
    }); #}
    
</script>
{% endblock %}