{% extends 'base.html.twig' %}

{% block title %} Dashboard Inventaire {{ inventory.name|capitalize }} {% endblock %}

{% block stylesheets %}
<!-- DataTables -->
<link href="/plugins/datatables/dataTables.bootstrap4.min.css" rel="stylesheet" type="text/css" />
<link href="/plugins/datatables/buttons.bootstrap4.min.css" rel="stylesheet" type="text/css" />
<!-- Responsive datatable examples -->
<link href="/plugins/datatables/responsive.bootstrap4.min.css" rel="stylesheet" type="text/css" /> 

<link href="/plugins/timepicker/bootstrap-material-datetimepicker.css" rel="stylesheet">
<link href="/plugins/bootstrap-datepicker/css/bootstrap-datepicker.min.css" rel="stylesheet">     

<!-- Clock css -->
<link href="/plugins/daterangepicker/daterangepicker.css" rel="stylesheet" />  

<!-- Sweet Alert -->
<link href="/plugins/sweet-alert2/sweetalert2.min.css" rel="stylesheet" type="text/css">

{% endblock %}

{% block pageTitle %}
<h4 class="page-title mb-2"><i class="mdi mdi-buffer mr-2"></i>Inventaire</h4>  
{% endblock %}

{% set iconStock = true %}
{% block breadcrumb %}
    <div class="">
        <ol class="breadcrumb">
            <li class="breadcrumb-item active">Dashboard</li>
            <li class="breadcrumb-item active">Inventaire</li>
            <li class="breadcrumb-item active">{{ (inventory.name)|capitalize }}</li>
        </ol>
    </div>
{% endblock %}

{% block body %}
    
    <div class="row">
        <div class="col-lg-12 col-sm-12">
            <div class="card">
                <div class="card-body table-responsive">
                    <h5 class="header-title">Statistiques de l'inventaire de {{ inventory.name|capitalize }}</h5>
                    
                    <div class="row my-3 align-items-center">
                        <div class="col-lg-3 my-3">
                            <a href="{{path('lot_create', {'prod':0, 'inv':inventory.id})}}"  class="btn btn-soft-primary btn-lg rounded mr-2 mb-2" data-toggle="tooltip" data-placement="top" title="Ajouter un nouveau lot dans l'inventaire de {{inventory.name|capitalize}}"><i class="fa fa-plus-circle "></i></a>
                            <a href="{{path('lots_index', {'prod':0, 'inv':inventory.id})}}" class="btn btn-soft-pink  btn-lg rounded mb-2" data-toggle="tooltip" data-placement="top" title="Voir les Lots de l'inventaire de {{inventory.name|capitalize}}"><i class="far fa-eye"></i></a>
                                                            
                        </div>
                        <div class="col-lg-9">
                            <label class="">Choisir la plage de date</label>
                            <div class="input-group">  
                                <input type="text"  id="reportrange" class="form-control" value="07/10/2020">
                                <div class="input-group-append">
                                    <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                </div>
                            </div>
                        </div>
                    </div> 
                    <!-- Nav tabs -->
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-toggle="tab" href="#statisticsTab" role="tab">Statistiques de Vente</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-toggle="tab" href="#stockMovementTab" role="tab">Mouvement de Stock</a>
                        </li>                                                
                        
                    </ul>

                    <!-- Tab panes mdi mdi-dump-truck mdi mdi-truck-check -->
                    <div class="">    
                        
                        {# {% autoescape %}{{ '<span class="badge bg">on pending</span>'|raw }}{% endautoescape %} #}
                        <div class="tab-content">
                            <div class="tab-pane active p-3" id="statisticsTab" role="tabpanel">    
                                {# <button type="button" id="deliveryJournalBtn" class="btn btn-info btn-xs rounded mr-1 mb-2" data-toggle="tooltip" data-placement="top" title="Print Delivery Journal"><i class="fa fa-print"></i></button>
                                <button type="button" id="inventoryExitJournalBtn" class="btn btn-info btn-xs rounded mr-1 mb-2" data-toggle="tooltip" data-placement="top" title="Print Inventory Exit Journal"><i class="fa fa-print"></i></button>  #}
                                <table id="statistics" class="table table-striped table-fixed nowrap table-striped table-bordered" style="border-collapse: collapse; border-spacing: 0; width: 100%;">
                                    <thead>
                                        <tr>
                                            <th colspan="2" class="text-center font-14">Details de Produit</th>
                                            <th colspan="4" class="text-center font-14">Statistiques de vente</th>
                                        </tr>
                                        <tr class="text-center">
                                            <th>SKU</th>
                                            <th>Name</th>
                                            <th>AVG Qty</th>
                                            <th>E.T</th>
                                            <th>Min Qty</th>
                                            <th>Max Qty</th>
                                            <th>Available</th>
                                            <th>Alerts</th>
                                            <th>Demand</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        {% for product in products %}                    
                                        <tr class="text-center">
                                            {# <td style="width:5px">
                                                <div class="checkbox checkbox-primary">
                                                    <input id="Journal{{commercialSheet.id}}" type="checkbox" name="journal" value="{{commercialSheet.id}}">
                                                    <label for="Journal{{commercialSheet.id}}"></label>
                                                </div>
                                            </td> #}
                                            <td>{{ product.sku }}</td>
                                            <td>{{ product.name }}</td>
                                            <td><span id="qtyAVG_{{product.id}}">0</span></td>
                                            <td><span id="ET_{{product.id}}">0</span></td>
                                            <td><span id="qtyMin_{{product.id}}">0</span></td>
                                            <td><span id="qtyMax_{{product.id}}">0</span></td>
                                            <td><span id="available_{{product.id}}">0</span></td>
                                            
                                            <td>
                                                {# <div class="checkbox checkbox-primary">
                                                    <input id="checkbox{{commercialSheet.id}}" type="checkbox" name="delivered" value="{{commercialSheet.id}}">
                                                    <label for="checkbox{{commercialSheet.id}}"></label>
                                                </div> dripicons-warning #}
                                                
                                                {# {% set ss = productStats[product.id][0]["ET"] * inventory.const %}
                                                {% set pc = ss + productStats[product.id][0]["qtyAVG"] * inventory.approvDelay %}
                                                {% if available[product.id].available <= pc %} #}
                                                <a href="" class="mr-2 d-none" id="alertRefuel_{{product.id}}" data-toggle="tooltip" data-placement="top" title="Alerte Réapprovisionnement">
                                                    <i class="fas fa-exclamation-triangle text-warning"></i>
                                                </a>
                                                <span class="bg bg-soft-success d-none" id="noAlertRefuel_{{product.id}}"></span>
                                                {# {% endif %} #}
                                                {% set lotPeremp = [] %}
                                                {% for lot in product.lots %}
                                                    {% if lot.alert == false and lot.quantity > 0 and lot.inventory == inventory %}
                                                        {% set lotPeremp = lotPeremp|merge([lot]) %}
                                                    
                                                    {% endif %} 
                                                {% endfor %}
                                                {% if lotPeremp|length > 0 %}
                                                {# <a href="#bd-example-modal-xl" class="waves-effect" data-animation="blur" data-plugin="custommodal" data-overlayColor="#38414a" data-toggle="tooltip" data-placement="top" title="Click to see alerts">
                                                    <i class="fas fa-exclamation-triangle text-danger "></i>
                                                </a> #}
                                                <a href="" class="" data-toggle="modal" data-target=".bd-example-modal-xl_{{product.id}}" data-toggle="tooltip" data-placement="top" title="Alerte Lots Expirés"><i class="fas fa-exclamation-triangle text-danger "></i></a>
                                                <!-- Custom Modal -->
                                                {# <div id="custom-modalAlert" class="modal-demo">
                                                    <button type="button" class="close" onclick="Custombox.modal.close();">
                                                        <span>&times;</span><span class="sr-only">Close</span>
                                                    </button>
                                                    <h4 class="custom-modal-title text-danger text-center">Expiration Alert</h4>
                                                    <div class="custom-modal-text">
                                                        <table id="" class="table dt-responsive nowrap table-striped table-bordered" style="border-collapse: collapse; border-spacing: 0; width: 100%;">
                                                            <thead>
                                                                <tr class="text-center">
                                                                    <th>N° Lot</th>
                                                                    <th>DLC</th>
                                                                    <th>Actions</th>
                                                                </tr>
                                                            </thead>

                                                            <tbody>
                                                                {% for lot in lotPeremp %}
                                                                <tr class="text-center">
                                                                    <td>{{ lot.number }}</td>
                                                                    <td>{{ lot.dlc|date('d-m-Y') }}</td>
                                                                    <td style="width:5px">
                                                                        <div class="checkbox checkbox-primary">
                                                                            <input id="Journal{{lot.id}}" type="checkbox" name="journal" value="{{lot.id}}">
                                                                            <label for="Journal{{lot.id}}"></label>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>

                                                        <div class="row mx-2 my-2 float-right">
                                                            <button type="button" id="saveBtn" data-action="place" data-target="{{'1'}}" class="btn btn-success btn-lg">
                                                                <span class="spinner-border spinner-border-sm mr-1 d-none" role="status" aria-hidden="true"></span>
                                                                Save
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div> #}

                                                <div class="modal fade bd-example-modal-xl_{{product.id}}" tabindex="-1" role="dialog" aria-labelledby="myExtraLargeModalLabel" aria-hidden="true">
                                                    <div class="modal-dialog modal-xl">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title mt-0" id="myModalLabel">Expiration Alert</h5>
                                                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                                            </div>
                                                            <div class="modal-body">
                                                                <table id="" class="table dt-responsive nowrap table-striped table-bordered" style="border-collapse: collapse; border-spacing: 0; width: 100%;">
                                                                    <thead>
                                                                        <tr class="text-center">
                                                                            <th>N° Lot</th>
                                                                            <th>DLC</th>
                                                                            <th>Actions</th>
                                                                        </tr>
                                                                    </thead>

                                                                    <tbody>
                                                                        {# {{dump(lotPeremp)}} #}
                                                                        {% for lot_ in lotPeremp %}
                                                                        <tr class="text-center">
                                                                            <td>{{ lot_.number }}</td>
                                                                            <td>{{ lot_.dlc|date('d-m-Y') }}</td>
                                                                            <td style="width:5px">
                                                                                <div class="checkbox checkbox-primary">
                                                                                    <input id="lot{{lot_.id}}" type="checkbox" name="lotToRemove" value="{{lot_.id}}">
                                                                                    <label for="lot{{lot_.id}}"></label>
                                                                                </div>
                                                                            </td>
                                                                        </tr>
                                                                        {% endfor %}
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary waves-effect" data-dismiss="modal">Close</button>
                                                                <button type="button" id="saveBtn" data-action="place" data-target="{{'1'}}" class="btn btn-success btn-lg">
                                                                    <span class="spinner-border spinner-border-sm mr-1 d-none" role="status" aria-hidden="true"></span>
                                                                    Save
                                                                </button>
                                                                
                                                            </div>
                                                        </div><!-- /.modal-content -->
                                                    </div><!-- /.modal-dialog -->
                                                </div>
                                                {% endif %}
                                            </td>
                                            <td><span id="demand_{{product.id}}"></span></td>
                                            <td>
                                                {# {{ productStats[product.id][0]["qtyAVG"] * inventory.orderingFreq }} <a href="#custom-modal{{'0'}}" class="btn btn-primary btn-xs rounded waves-effect" data-animation="corner" data-plugin="custommodal" data-overlayColor="#38414a" data-toggle="tooltip" data-placement="top" title="Add New Lot"><i class="fa fa-plus-circle"></i></a> #}
                                                <a href="{{path('lot_create', {'prod':product.id, 'inv':inventory.id})}}"  class="btn btn-soft-info btn-xs rounded " data-toggle="tooltip" data-placement="top" title="Ajouter un nouveau lot pour le produit {{product.name}}"><i class="fa fa-plus-circle"></i></a>
                                                <a href="{{path('lots_index', {'prod':product.id, 'inv':inventory.id})}}" class="btn btn-soft-purple btn-xs rounded" data-toggle="tooltip" data-placement="top" title="Voir les Lots du produit {{product.name}}"><i class="far fa-eye"></i></a>
                                                {# <a href="#custom-modal{{'1'}}" class="btn btn-danger btn-xs rounded waves-effect" data-animation="corner" data-plugin="custommodal" data-overlayColor="#38414a" data-toggle="tooltip" data-plas"top" title="Remove Lot"><i class="fas fa-trash"></i></a> #}
                                            </td> 
                                            
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>                    
                            </div>

                            <div class="tab-pane p-3" id="stockMovementTab" role="tabpanel">
                              {# <div class="form-group my-2">
                                    <h6 class=" input-title mt-lg-3">Specify the Date Range</h6>
                                    <div class="row">
                                        <div class="input-daterange input-group col-6" id="date-range">
                                            <input type="text" class="form-control" name="start" placeholder="Start Date (dd/mm/yyyy)" />
                                            <input type="text" class="form-control" name="end" placeholder="End Date (dd/mm/yyyy)" />
                                            <span class="input-group-append">
                                                <button type="button" id="reloadBtn" class="btn btn-soft-primary"><i class="fas fa-sync"></i> </button>
                                            </span>
                                        </div>
                                    </div>
                                </div> #}
                                <div class="table-responsive">
                                    <table id="datatable-buttons" class="table table-striped table-fixed nowrap" style="border-collapse: collapse; border-spacing: 0; width: 100%;">
                                        <thead>
                                            <tr class="text-center">
                                                {# <th style="width:0.5em"></th> #}
                                                <th>Date</th>
                                                <th>SKU</th>
                                                <th>Name</th>
                                                <th>N° Lot</th>
                                                <th>DLC</th>
                                                <th>Type</th>
                                                <th>Qté</th>
                                            </tr>
                                        </thead>

                                        <tbody>
                                            {# {% for i in range(1,4) %}
                                            <tr class="text-center align-items-center">
                                                <td></td> 
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td class="align-items-center">
                                                    
                                                    
                                                </td>
                                                <td></td>
                                                
                                            </tr>
                                            {% endfor %} #}
                                        </tbody>
                                    </table>
                                </div>
                            </div>  

                        </div>

                    </div> <!--end div-->
                    
                </div>
            </div>
        </div>
    </div><!--end row-->
{% endblock %}

{% block javascripts %}
<!-- Required datatable js -->
<script src="/plugins/datatables/jquery.dataTables.min.js"></script>
<script src="/plugins/datatables/dataTables.bootstrap4.min.js"></script>
<!-- Buttons examples -->
{# <!-- 

https://code.jquery.com/jquery-3.5.1.js
https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js
https://cdn.datatables.net/fixedheader/3.1.7/js/dataTables.fixedHeader.min.js
https://cdn.datatables.net/buttons/1.6.4/js/dataTables.buttons.min.js
https://cdn.datatables.net/buttons/1.6.4/js/buttons.colVis.min.js

--> #}
<script src="/plugins/datatables/dataTables.buttons.min.js"></script>
<script src="/plugins/datatables/buttons.bootstrap4.min.js"></script>
<script src="/plugins/datatables/jszip.min.js"></script>
<script src="/plugins/datatables/pdfmake.min.js"></script>
<script src="/plugins/datatables/vfs_fonts.js"></script>
<script src="/plugins/datatables/buttons.html5.min.js"></script>
<script src="/plugins/datatables/buttons.print.min.js"></script>
<script src="/plugins/datatables/buttons.colVis.min.js"></script>
<!-- Responsive examples -->
<script src="/plugins/datatables/dataTables.responsive.min.js"></script>
<script src="/plugins/datatables/responsive.bootstrap4.min.js"></script>
<script src="/pages/jquery.datatable.init.js"></script>    

<script src="/plugins/custombox/custombox.min.js"></script>
<script src="/plugins/custombox/custombox.legacy.min.js"></script>

<script src="/pages/jquery.modal-animation.js"></script>
<script src="/js/jquery.redirect.js"></script>  

<!-- Plugins js -->
<script src="/plugins/moment/moment.js"></script>
<script src="/plugins/daterangepicker/daterangepicker.js"></script>
<script src="/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js"></script>
<script src="/pages/jquery.forms-advanced.js"></script>

<!-- Sweet-Alert  -->
<script src="/plugins/sweet-alert2/sweetalert2.min.js"></script>


<script>
    var alertRefuel = '<a href="" class="mr-2 d-none" data-toggle="tooltip" data-placement="top" title="Alerte Réapprovisionnement"><i class="fas fa-exclamation-triangle text-warning"></i></a>';
    
    /*var rowHtml = $("#newRow").find("tr")[0].outerHTML
    console.log(rowHtml);
    t.row.add($(rowHtml)).draw();*/

    var inv = {{ inventory.id }};
    
    /*var statsTable = $('#statistics').DataTable({
        lengthChange: false,
        //buttons: ['pdf'],//'copy', 'excel', , 'colvis'
        //ajax: "data.json"
    });*/
    
    //Buttons examples
    var table = $('#datatable-buttons').DataTable({
        //lengthChange: true,
        lengthMenu: [ [10, 25, 50, -1], [10, 25, 50, 100, "All"] ],
        pageLength: 100,
        buttons: ['pdf'],//'copy', 'excel', , 'colvis'
        //ajax: "data.json"
    });

    table.buttons().container()
        .appendTo('#datatable-buttons_wrapper .col-md-6:eq(0)');
    var const_ = {{ inventory.const }};
    var approvDelay = {{ inventory.approvDelay }};
    var freqReapp = {{ inventory.orderingFreq }};

    var _url = "{{path('stock_movement_update')}}";
        
    $('#reportrange').on('apply.daterangepicker', function(ev, picker) {
        //console.log(picker.startDate.format('YYYY-MM-DD'));
        //console.log(picker.endDate.format('YYYY-MM-DD'));
    
        //$('.fa-sync').addClass('fa-spin');
        var startDate = picker.startDate.format('YYYY-MM-DD');
        var endDate = picker.endDate.format('YYYY-MM-DD');
        
        //console.log('startDate = ' + startDate);
        //console.log('endDate = ' + endDate);
        //block of code that runs when the click event triggers
        
        var $data = JSON.stringify({
            "startDate": startDate,//tabGridId,
            "endDate": endDate,//tabFuelId,
            "inv": inv
        });   

        //Danger
        
        swal.queue([{
            title: 'Les données des tableaux seront mise à jour pour la plage de date suivante : ',
            confirmButtonText: 'Confirmez',
            text: 'Du ' + startDate + ' Au ' + endDate,
            showCancelButton: true,
            showLoaderOnConfirm: true,
            confirmButtonClass: 'btn btn-primary',
            cancelButtonClass: 'btn btn-info ml-2',
            preConfirm: function () {
                return new Promise(function (resolve) {
                    /*$.get('https://api.ipify.org?format=json')
                        .done(function (data) {
                            swal.insertQueueStep(data.ip)
                            resolve()
                        })*/
                    $.ajax({
                        type: "POST",//method type
                        contentType: "application/json; charset=utf-8",
                        url: "{{path('stock_movement_update')}}",///Target function that will be return result
                        data: $data,//parameter pass data is parameter name param is value 
                        dataType: "json",
                        timeout: 120000,//64241
                        success: function (data) {
                            //$('.fa-sync').removeClass('fa-spin');                                  
                            //console.log(data);
                            
                            //console.log(data['productStats']);

                             //statsTable.clear().draw(); 
                            table.clear().draw();
                            var ss = 0, pc = 0.0; 
                            
                            data['productStats'].forEach(function (value, index) {
                                console.log('value = ' + value);
                                $('#qtyAVG_' + value['id']).text(value['AVG']);
                                $('#ET_' + value['id']).text(value['ET']);
                                $('#qtyMin_' + value['id']).text(value['MIN']);
                                $('#qtyMax_' + value['id']).text(value['MAX']);
                                $('#available_' + value['id']).text(data['available'][index]['av']);
                                
                                /*statsTable
                                    .row.add( [ value['Sku'], String(value['Name']), 
                                    String(value['AVG']), String(value['ET']),value['MIN'],
                                    String(value['MAX']), String(data['available'][index]['av'])] )
                                    .draw();*/

                                ss = parseFloat(value['ET']) * const_;
                                pc = ss + parseFloat(value['AVG']) * approvDelay;

                                if(parseInt(data['available'][index]['av']) <= pc){
                                    $('#alertRefuel_' + value['id']).removeClass('d-none');
                                    $('#noAlertRefuel_' + value['id']).addClass('d-none');
                                    var tmp = parseFloat(value['AVG']) * freqReapp;
                                    $('#demand_' + value['id']).text(Math.ceil(tmp));
                                    //console.log('alert');
                                }
                                else {
                                    $('#alertRefuel_' + value['id']).addClass('d-none');
                                    $('#noAlertRefuel_' + value['id']).removeClass('d-none');
                                    $('#demand_' + value['id']).text(0);
                                    //console.log('no alert');
                                }
                            });

                            var stockMovementTab = data['stockMovements'];
                            if(stockMovementTab){
                                //console.log('Type = ' + typeof stockMovementTab.length);  
                                //console.log(stockMovementTab);  
                                stockMovementTab.forEach(function (item, index) {
                                    {# var $dat = new moment(String(item['dat']));
                                    var date = $dat.format("DD MMM YYYY hh:mm:ss").toString();
                                    
                                    $dat = new moment(String(item['dlc']));
                                    var dlc = $dat.format("DD MMM YYYY").toString(); #}
                        
                                    table
                                    .row.add( [ item['dat'], String(item['sku']), 
                                    String(item['nam']), String(item['numLot']),item['dlc'],
                                    String(item['typ']), String(item['qty'])] )
                                    .draw();

                                });

                            } 
                            swal({
                                type: 'success',
                                title: 'Les Données de la page ont été Mis à Jour avec succès !',
                                //html: 'Submitted email: ' + email
                            });

                            setTimeout(function () {
                                resolve()
                            }, 2000);
                        },
                        error: function (result) {
                            //console.log("Error");
                            //console.log(result);
                            swal(
                                'Oops...',
                                'Something went wrong!',
                                'error'
                                //footer: '<a href>Why do I have this issue?</a>'
                            );

                            setTimeout(function () {
                                resolve()
                            }, 5000);
                        }
                    });
                })
            },
            allowOutsideClick: false
        }]);
        

    });


    var drp = $('#reportrange').data('daterangepicker');
    //console.log('drp = ' + drp.startDate.format('YYYY-MM-DD'));
    var startDate = drp.startDate.format('YYYY-MM-DD');
    var endDate = drp.endDate.format('YYYY-MM-DD');
    
    // console.log('startDate = ' + startDate);
    //console.log('endDate = ' + endDate); 
    //block of code that runs when the click event triggers
    
    var $data = JSON.stringify({
        "startDate": startDate,//tabGridId,
        "endDate": endDate,//tabFuelId,
        "inv": inv
    });   

    //Danger
    
    swal.queue([{
        title: 'Les données des tableaux seront mise à jour pour la plage de date suivante : ',
        confirmButtonText: 'Confirmez',
        text: 'Du ' + startDate + ' Au ' + endDate,
        //showCancelButton: true,
        showLoaderOnConfirm: true,
        confirmButtonClass: 'btn btn-primary',
        //cancelButtonClass: 'btn btn-info ml-2',
        preConfirm: function () {
            return new Promise(function (resolve) {
                /*$.get('https://api.ipify.org?format=json')
                    .done(function (data) {
                        swal.insertQueueStep(data.ip)
                        resolve()
                    })*/
                $.ajax({
                    type: "POST",//method type
                    contentType: "application/json; charset=utf-8",
                    url: _url,///Target function that will be return result
                    data: $data,//parameter pass data is parameter name param is value 
                    dataType: "json",
                    timeout: 120000,//64241
                    success: function (data) {
                        //$('.fa-sync').removeClass('fa-spin');                                  
                        //console.log(data);
                        
                        //console.log(data['productStats']);

                        // statsTable.clear().draw(); 
                        table.clear().draw();
                        var ss = 0, pc = 0.0; 
                        
                        data['productStats'].forEach(function (value, index) {
                            //console.log('value = ' + value);
                            $('#qtyAVG_' + value['id']).text(value['AVG']);
                            $('#ET_' + value['id']).text(value['ET']);
                            $('#qtyMin_' + value['id']).text(value['MIN']);
                            $('#qtyMax_' + value['id']).text(value['MAX']);
                            $('#available_' + value['id']).text(data['available'][index]['av']);
                            
                            {# statsTable
                                .row.add( [ value['Sku'], String(value['Name']), 
                                String(value['AVG']), String(value['ET']),value['MIN'],
                                String(value['MAX']), String(data['available'][index]['av'])] )
                                .draw(); #}

                            ss = parseFloat(value['ET']) * const_;
                            pc = ss + parseFloat(value['AVG']) * approvDelay;

                            if(parseInt(data['available'][index]['av']) <= pc){
                                $('#alertRefuel_' + value['id']).removeClass('d-none');
                                $('#noAlertRefuel_' + value['id']).addClass('d-none');
                                var tmp = parseFloat(value['AVG']) * freqReapp;
                                $('#demand_' + value['id']).text(Math.ceil(tmp));
                                // console.log('alert'); 
                            }
                            else {
                                $('#alertRefuel_' + value['id']).addClass('d-none');
                                $('#noAlertRefuel_' + value['id']).removeClass('d-none');
                                $('#demand_' + value['id']).text(0);
                                // console.log('no alert'); 
                            }
                        });

                        var stockMovementTab = data['stockMovements'];
                        if(stockMovementTab){
                            //console.log('Type = ' + typeof stockMovementTab.length);  
                            //console.log(stockMovementTab);  
                            stockMovementTab.forEach(function (item, index) {
                                {# var $dat = new moment(String(item['dat']));
                                var date = $dat.format("DD MMM YYYY hh:mm:ss").toString();
                                
                                $dat = new moment(String(item['dlc']));
                                var dlc = $dat.format("DD MMM YYYY").toString(); #}
                    
                                table
                                .row.add( [ item['dat'], String(item['sku']), 
                                String(item['nam']), String(item['numLot']),item['dlc'],
                                String(item['typ']), String(item['qty'])] )
                                .draw();

                            });

                        } 
                        swal({
                            type: 'success',
                            title: 'Les Données de la page ont été Mis à Jour avec succès !',
                            //html: 'Submitted email: ' + email
                        });

                        setTimeout(function () {
                            resolve()
                        }, 2000);
                    },
                    error: function (result) {
                        //console.log("Error");
                        //console.log(result);
                        swal(
                            'Oops...',
                            'Something went wrong!',
                            'error'
                            //footer: '<a href>Why do I have this issue?</a>'
                        );

                        setTimeout(function () {
                            resolve()
                        }, 5000);
                    }
                });
            })
        },
        allowOutsideClick: false
    }]);
                  
    $('#saveBtn').click(function(){
        //console.log('Lot To Remove Btn clicked');
        var tabLotToRemove = [];
        $("input:checkbox[name=lotToRemove]:checked").each(function(){
            tabLotToRemove.push($(this).val());
        });
        //console.log('Tab Lot To Remove : ' + tabLotToRemove);
        if (tabLotToRemove.length > 0){

            var _url = "{{ path('lot_expired') }}";

            var $data = JSON.stringify({
                "lotIds": tabLotToRemove
            });

            $.ajax({
                type: "POST",//method type
                contentType: "application/json; charset=utf-8",
                url: _url,///Target function that will be return result
                data: $data,//parameter pass data is parameter name param is value 
                dataType: "json",
                timeout: 120000,//64241
                success: function (data) {
                    //console.log(data);
                    location.reload(true);
                },
                error: function (result) {
                    //console.log("Error");
                    //console.log(result);
                    alert('Erreur !!!');
                    //$('#modal').modal('toggle');
                }
            });

        }
    });
    
</script>
{% endblock %}